html>
  <head>
    <title>AB Paradigm</title>
    <script src="jsPsych/jspsych.js"></script>
    <script src="jsPsych/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jsPsych/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="jsPsych/plugins/jspsych-fullscreen.js"></script>
    <script src="jsPsych/plugins/jspsych-instructions.js"></script>
	<script src="jsPsych/plugins/jspsych-survey-multi-choice.js"></script>
	<script src="jsPsych/plugins/jspsych-resize.js"></script>
	<script src="jsPsych/plugins/jspsych-virtual-chinrest.js"></script>
    <link href="jsPsych/css/jspsych.css" rel="stylesheet" type="text/css">
  </head>
  <body></body>
  <script>
//Code adapted from paulsharpeY by Jordan Wylie & Dries Bostyn
///////////////////////////////////////////////////////
var rsvp_task = []; // main timeline

var welcome = {
      type: "html-keyboard-response",
      stimulus: '<div style="color:black;font-size:40px;line-height:1.5">Welcome to our experiment! We will first switch your computer to full screen. <p>Press any key to begin.</p></div>',
    };
    rsvp_task.push(welcome);

/* Computer things */

rsvp_task.push({
  type: 'fullscreen',
  fullscreen_mode: true
});

var compSize = {
  type: 'resize',
  item_width: 3 + 3/8,
  item_height: 2 + 1/8,
  prompt: "<p>First, we need to adjust the dimensions of the experiment to fit your screen. Click and drag the lower right corner of the box until the box is the same size as any credit card you have held up to the screen.</p>",
  pixels_per_unit: 150
};
rsvp_task.push(compSize);

// no blindspot task
// resize to cm (50 pixels per unit)
// measure px2mm, but not viewing distance and px2deg (because blindspot_reps is 0)
// note: you may still choose to estimate viewing distance even if resizing to cm or inches
let cm_resize = {
  type: "virtual-chinrest",
  blindspot_reps: 0,
  resize_units: "cm",
  pixels_per_unit: 50,
};
rsvp_task.push(cm_resize);

///////////////////////////////////////////////////////

//////////////////////////////////////
/* define instructions trial */
//////////////////////////////////////

var instructionsGEN = {
      type: "instructions",
      pages: ['<div style="color:black;font-size:30px;line-height:1.5"> This experiment tests your memory about words. </p>' +
          " <p> First, you will read a short passage and answer some questions.</p>"+ 
          ' <p> Then, you will be tested on your ability to remember two words that appear in green. We will begin with a practice trial. </p>' +
          " <p><b>Please press the right arrow key to continue. </b></p></div>"],
        key_forward: 'rightarrow',
      post_trial_gap: 1500
    };
	rsvp_task.push(instructionsGEN);

// instructions
var instructions_1 = {
  type: "html-keyboard-response",
  stimulus: "<div class='instructions'><p>You will see a series of letters and numbers rapidly " +
            "appearing on the computer screen. Your task is to remember " +
            "the digits in the series.</p><p>When the series ends, you have to " +
            "respond to the question ‘which two digits did you see?’</p><p>You " +
            "type in the digits you saw (order does not matter), and then " +
            "another series will appear.</p>" +
            "<p>Press any key to see an example of the task.</p></div>",
  data: {test_part: 'instructions'},
  post_trial_gap: 1000
};
rsvp_task.push(instructions_1);

// make slow instruction trial
rsvp_task.push(make_rsvp_timeline([ {t1_location: 8, lag: 3} ], 'instructions'));

var instructions_2 = {
  type: "html-keyboard-response",
  stimulus: "<div class='instructions'><p>In the example you just saw, " +
            "the letters and numbers appeared quite slowly.</p>" +
            "<p>The real task is more challenging, as the letters and numbers " +
            "will appear much more rapidly.</p>" +
            "<p>You will have some time to practice before starting the test.</p>" +
            "<p>Press any key to start the practice.</p></div>",
  data: {test_part: 'instructions_2'},
  post_trial_gap: 1000
};
rsvp_task.push(instructions_2);


var instructionsENCODE = {
      type: "instructions",
      pages: ['<div style="color:black;font-size:30px;line-height:1.5"> We will now present a set of 10 faces for you to remember. Please try to remember each these of the faces as best you can.' +
        '<b><p> Please press the right arrow key to continue. </p></b></div>'],
        key_forward: 'rightarrow',
      post_trial_gap: 1500
    };
	rsvp_task.push(instructionsENCODE);



///////////////////////////////////////////////////////
// AB stimuli
var response_choices = keyCodeRange('f', 'j');
var stimulitarget1 = [
      { img: "jsPsych/examples/img/Brett Kavanaugh.png"},
      { img: "jsPsych/examples/img/Joseph Stalin.png"},
      { img: "jsPsych/examples/img/Fidel Castro.png"},
      { img: "jsPsych/examples/img/Harvey Weinstein.png"},
      { img: "jsPsych/examples/img/Ted Bundy.png"},
      { img: "jsPsych/examples/img/Kevin Spacey.png"},
      { img: "jsPsych/examples/img/Pablo Escobar.png"},
      { img: "jsPsych/examples/img/Saddam Hussein.png"},
      { img: "jsPsych/examples/img/Bennito Mussolini.png"},
      { img: "jsPsych/examples/img/Larry Nassar.png"}
    ]

var stimulitarget2 = [
      {  img2:  "jsPsych/examples/img/Brett Kavanaugh_label.png"},
      {  img2:  "jsPsych/examples/img/Joseph Stalin_label.png.png"},
      {  img2:  "jsPsych/examples/img/Fidel Castro_label.png"},
      {  img2:  "jsPsych/examples/img/Harvey Weinstein_label.png"},
      {  img2:  "jsPsych/examples/img/Ted Bundy_label.png"},
      {  img2:  "jsPsych/examples/img/Kevin Spacey_label.png"},
      {  img2:  "jsPsych/examples/img/Pablo Escobar_label.png"},
      {  img2:  "jsPsych/examples/img/Saddam Hussein_label.png"},
      {  img2:  "jsPsych/examples/img/Bennito Mussolini_label.png"},
      {  img2:  "jsPsych/examples/img/Larry Nassar_label.png"}
    ]
 var distract_stimuli = [
        "jsPsych/examples/img/Jeffrey Epstein.png",
        "jsPsych/examples/img/Jeffrey Dahmer.png",
        "jsPsych/examples/img/El Chapo.png",
        "jsPsych/examples/img/Qasem Soleimani.png",
        "jsPsych/examples/img/Steve Bannon.png",
        "jsPsych/examples/img/Lee Harvey Oswald.png",
        "jsPsych/examples/img/Matt Lauer.png",
        "jsPsych/examples/img/Vladimir Lenin.png",
        "jsPsych/examples/img/Rudy Guiliani.png",
        "jsPsych/examples/img/Lance Armstrong.png",
        "jsPsych/examples/img/Karl Rove.png",
        "jsPsych/examples/img/Charles Manson.png",
        "jsPsych/examples/img/Robert E. Lee.png",
        "jsPsych/examples/img/Adolf Eichmann.png",
        "jsPsych/examples/img/Heinrich Himmler.png",
        "jsPsych/examples/img/Joseph Goebbels.png",
        "jsPsych/examples/img/Ghengis Khan.png"
    ]
//////////////////////////////////////
//beginning encoding period/manipulation

//* Between Cond 1 = ΝΟ LABEL
var encode1 = {
        type: 'image-keyboard-response',
        stimulus: jsPsych.timelineVariable('img'),
        choices: jsPsych.NO_KEYS,
        trial_duration: 3000
      };
var encode_procedure1 = {
    timeline: [fixation, encode1],
    timeline_variables: stimulitarget1, 
    randomize_order: true 
};

//* Between Cond 2 = LABEL
var encode2 = {
        type: 'image-keyboard-response',
        stimulus: jsPsych.timelineVariable('img2'),
        choices: jsPsych.NO_KEYS,
        trial_duration: 3000
      };

  var encode_procedure2 = {
      timeline: [fixation, encode2],
      timeline_variables: stimulitarget2,
      randomize_order: true
  };

//* Set up conditions */
//////////////////////////////////////

var conditions = [encode_procedure1, encode_procedure2];
var cond = jsPsych.randomization.sampleWithoutReplacement(conditions,1)[0];
console.log('condition: ', cond);  // check console to see which condition was selected
timeline.push(cond);

//////////////////////////////////////
// stimuli definitions

var fixation = {
        type: 'html-keyboard-response',
        stimulus: '<div style="font-size:60px;">+</div>',
        choices: jsPsych.NO_KEYS,
        trial_duration: function(){
          return jsPsych.randomization.sampleWithReplacement([250, 500, 750, 1000, 1250, 1500], 1)[0];
        },
		data: {test_part: 'fixation'}
      };

var rsvp_iti = {
    type: 'html-keyboard-response',
    stimulus: '<span></span>',
    choices: jsPsych.NO_KEYS,
    trial_duration: 30,
    data: {test_part: 'iti'}
};
var rsvp_demo_iti = {
    type: 'html-keyboard-response',
    stimulus: '<span></span>',
    choices: jsPsych.NO_KEYS,
    trial_duration: 90,
    data: {test_part: 'iti'}
};
var blank = {
  type: 'html-keyboard-response',
  stimulus: '<div class="rsvp"></div>',
  choices: jsPsych.NO_KEYS,
  trial_duration: 250,
  data: {test_part: 'blank'}
}
var rsvp_stimulus_block = {
    type: 'html-keyboard-response',
    stimulus: jsPsych.timelineVariable('stimulus'),
    choices: jsPsych.NO_KEYS,
    trial_duration: 70,
    data: jsPsych.timelineVariable('data'),
};
var rsvp_demo_stimulus_block = {
    type: 'html-keyboard-response',
    stimulus: jsPsych.timelineVariable('stimulus'),
    choices: jsPsych.NO_KEYS,
    trial_duration: 210,
    data: jsPsych.timelineVariable('data'),
};
var response_block = {
  type: "html-keyboard-response",
  stimulus: jsPsych.timelineVariable('stimulus'),
  prompt: jsPsych.timelineVariable('prompt'),
  choices: response_choices,
  data: jsPsych.timelineVariable('data'),
  trial_duration: 5000,
  on_finish: function(data) {
    data.correct = data.correct_responses.includes(data.key_press); // accuracy irrespective of order
    if ( ! data.lag ) {                                             // only T2 has a lag
	    data.t1_correct = data.correct_response == data.key_press;  // T1 accuracy
	} else {
	    data.t2_correct = data.correct_response == data.key_press;  // T2 accuracy
	}
  }
}

// Factorial design
// 3 locations x 4 lags = 12
var factors = {
    t1_location: [7, 8, 9],
    lag: [1, 3, 5, 8]
};
var practice_repetitions = 2;
var test_repetitions     = 12;
var practice_block       = 0;

var performance_block = {
  type: "html-keyboard-response",
  stimulus: function() {
  	var practice_trials = practice_repetitions * 12;
  	var correct         = 0;
  	for (i = 1; i <= practice_trials; i++) {
  		var trials         = jsPsych.data.get().filter({phase: 'practice' + practice_block});
	    trials             = trials.filter({trial_number: i});
		var correct_trials = trials.filter({correct: true});
		if (correct_trials.count() > 1) correct++;
  	}
    var accuracy = Math.round(correct / practice_trials * 100);
    if (accuracy >= 50) {
    	// practice accuracy achieved, so build test trials
    	var test_timeline = make_rsvp_timeline(jsPsych.randomization.factorial(factors, test_repetitions), 'test');
		jsPsych.addNodeToEndOfTimeline(test_timeline, function(){});
		var thanks = {
		  type: "html-keyboard-response",
		  stimulus: "<div class='instructions'><p>Thank you for completing this task.</p><p>Press any key to continue.</p></div>",
		  trial_duration: 10000,
		  data: {test_part: 'end'}
		};
		jsPsych.addNodeToEndOfTimeline(thanks, function(){});
		var feedback = "<div class='instructions'><p>Well done!  You responded correctly on "+accuracy+"% of the trials.</p>" +
	    "<p>Press any key to start the test.</p></div>";
    } else {
    	// practice accuracy too low, so repeat practice
    	practice_block++;
    	var practice_timeline = make_rsvp_timeline(jsPsych.randomization.factorial(factors, practice_repetitions), 'practice' + practice_block);
    	practice_timeline.timeline.push(performance_block);
    	jsPsych.addNodeToEndOfTimeline(practice_timeline, function(){});
	    var feedback = "<div class='instructions'><p>You responded correctly on "+accuracy+"% of the trials.</p>" +
	    "<p>You need to score at least 50% before starting the test.</p>" +
	    "<p>Press any key to repeat the practice.</p></div>";
	}
	return feedback;
  }
};
// make initial practice block
rsvp_task.push(make_rsvp_timeline(jsPsych.randomization.factorial(factors, practice_repetitions), 'practice' + practice_block));
rsvp_task.push(performance_block);

/** functions **/
function alphabetRange (start, end) {
  return new Array(end.charCodeAt(0) - start.charCodeAt(0) + 1).fill().map((d, i) => String.fromCharCode(i + start.charCodeAt(0)));
}
function keyCodeRange (start, end) {
	var start = start.charCodeAt(0);
  return new Array(end.charCodeAt(0) - start + 1).fill().map((d, i) => i + start);
}

///////////////////////////////////////////////////////////////
function rsvp_trial(o) {
	var stimuli                    = jsPsych.randomization.sampleWithoutReplacement(distract_stimuli, 10);
	var targets                    = jsPsych.randomization.sampleWithoutReplacement(stimulitarget1, 2);
	stimuli[o.t1_location]         = targets[0];
	stimuli[o.t1_location + o.lag] = targets[1];

	return({stimuli: stimuli, targets: targets.map(jsPsych.pluginAPI.convertKeyCharacterToKeyCode)});
}

///////////////////////////////////////////////////////////////
// Make a block of RSVP stimuli and responses
function make_rsvp_timeline(trials, phase) {
	rsvp_timeline = [];
	trial_number  = 0;
	for (trial in trials) {
		trial_number++;
		rsvp_stimuli = rsvp_trial(trials[trial]);

		// RSVP: 20 distractors, 10 targets targets
		var rsvp_block_stimuli = [];
		for (stimulus in rsvp_stimuli.stimuli) {
			rsvp_block_stimuli.push(
	  			{
	  				stimulus: "<span class='rsvp'>" + rsvp_stimuli.stimuli[stimulus] + "</span>",
	  				data: {
	  					phase: phase,
	  					test_part: 'rsvp',
	  					stim: rsvp_stimuli.stimuli[stimulus],
	  					trial_number: trial_number
	  				}
	  			}
	  		);
		}
		// attach RSVP stimuli to a timeline
		if (phase == 'instructions') {
			// slow stimuli
			stimulus_trial = rsvp_demo_stimulus_block;
			iti_trial      = rsvp_demo_iti;
		} else {
			stimulus_trial = rsvp_stimulus_block;
			iti_trial      = rsvp_iti;
		}
		var test_procedure = {
			timeline: [stimulus_trial, iti_trial],
			timeline_variables: rsvp_block_stimuli
		}

		// 2 responses
	  	var rsvp_response_stimuli = [];
	  	// T1
	  	rsvp_response_stimuli.push(
			{
				stimulus:'<div class="rsvp">Whose face did you see?</div>',
				prompt: '<p class="rsvp">(type in the name of the person you saw)</p>',
				data: {
					phase: phase,
					test_part: 'response',
					correct_responses: rsvp_stimuli.targets,
					correct_response: rsvp_stimuli.targets[0],
					trial_number: trial_number
				}
			}
		);
	  	// T2
		rsvp_response_stimuli.push(
			{
				stimulus:'<div class="rsvp">v</div>',
				prompt: '<p class="rsvp">(type in the name of the person you saw)</p>',
				data: {
					phase: phase,
					test_part: 'response',
					correct_responses: rsvp_stimuli.targets,
					correct_response: rsvp_stimuli.targets[1],
					lag: trials[trial].lag,
					trial_number: trial_number
				}
			}
		);
		// attach responses to timeline
		var response_procedure = {
			timeline: [response_block],
			timeline_variables: rsvp_response_stimuli
		}
		rsvp_timeline.push(fixation);
		rsvp_timeline.push(blank);
		rsvp_timeline.push(test_procedure);
		rsvp_timeline.push(response_procedure);
	}
	return { timeline: rsvp_timeline }
}
